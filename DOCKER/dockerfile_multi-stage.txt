# Stage 1: build/copy site assets

FROM alpine AS builder

WORKDIR /app

COPY . .

# Stage 2: nginx runtime
FROM nginx:alpine

# 1. Create a non-root user/group
RUN addgroup -g 1001 web && adduser -D FH -u 1001 -G web web

# 2. Copy static site into nginx html root
RUN rm -rf /usr/share/nginx/html/*
COPY --from=builder /app /usr/share/nginx/html

# 3. Make nginx listen on 8080 instead of 80 (non-root can't bind to 80)
RUN sed -i ‘'s/listen\s\+80;/listen 8080;/' /etc/nginx/conf.d/default.conf

# 4, Remove the “user nginx;" line from nginx.conf to avoid warnings
RUN sed -i '/*user\s\+/d' /etc/nginx/nginx.conf

# 5. Fix permissions for all runtime write locations
# - /var/cache/nginx : temp dirs (client_temp, proxy temp, etc.)
# - /var/run : some distros still use this path
# - /run : nginx in your logs is writing pid here
# - /usr/share/nginx/html : your static content
# - /etc/nginx/... : allow reading config
RUN chown -R web:web \

/var/cache/nginx \

/var/run \

/run \

/usr/share/nginx/html \

/etc/nginx/conf.d \

/etc/nginx/nginx.conf

# 6. Drop root
USER web

# 7. Expose the port nginx is actually listening on
EXPOSE 8080

# 8. Start nginx in foreground

CMD ["nginx", "-g", "daemon off;"]

